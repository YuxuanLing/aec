/******************************************************************************* */
/* ----------------------------------------------------------------------------  */
/*                                gt60.c                                         */
/* ----------------------------------------------------------------------------  */
/*                                                                               */
/*  Author        : EHO                                                           */
/*                                                                               */
/*  Description   : Complex 768 point Forward Fast Fourier Transform (FFT).       */
/*                                                                               */
/*  gt384() computes a complex 768-point DFT using Good-Thomas decomposition.      */
/*                                                                               */
/*  All pointers are of type double * to avoid confusion about whether           */
/*  they need to be DW-aligned (obviously they have to).                         */
/*                                                                               */
/*  The implementation is done by recursive decomposition according to the       */
/*  Good-Thomas scheme. Please refer to gt240.c for a detailed discussion        */
/*  about Good-Thomas decomposition.                                             */
/*                                                                               */
/*  The 768pt FFT is being decomposed as GT(3,256). As seen in the figure   */
/*  below, some reordering steps have been merged (the dotted lines).            */
/*                                                                               */
/*     ............................................................              */
/*     .   +--------------------------------------------------+   .              */
/*     .   | i)   k-index reordering                          |   . => ktab      */
/*     .   +--------------------------------------------------+   .              */
/*     ............................|...............................              */
/*         +-----------------------v--------------------------+                  */
/*         | ii)  3 FFTs of size 256                          |                  */
/*         +--------------------------------------------------+                  */
/*     ............................|...............................              */
/*     .   +-----------------------v--------------------------+   .              */
/*     .   | iii) intermediate reordering                     |   .              */
/*     .   +--------------------------------------------------+   .              */
/*     .                           |                              .              */
/*     .   +-----------------------v--------------------------+   . => itab      */
/*     .   | iv)  256 FFTs of size 3                            |   .              */
/*     .   |                                                  |   .              */
/*     .   +-----------------------v--------------------------+  .               */
/*     .   | v)   n-index reordering                          |  .               */
/*     .   +--------------------------------------------------+  .               */
/*     ...........................................................               */
/*                                                                               */
/*   3-pt FFTs                                                                   */
/*   -----------------                                                           */
/*   The implementation of the 3-point FFTs is straight forward from theory      */
/* ----------------------------------------------------------------------------- */
#include "fft.h"

#include "fftutil.h"

#include "gt_fft_mem.h"
#include "gt_fft.h"
#include <stdio.h>
#include <stdarg.h>


static unsigned short ktab384[384] = {
 0,   299, 214, 1,   300, 215, 2,   301,
 216, 3,   302, 217, 4,   303, 218, 5,
 304, 219, 6,   305, 220, 7,   306, 221,
 8,   307, 222, 9,   308, 223, 10,  309,
 224, 11,  310, 225, 12,  311, 226, 13,
 312, 227, 14,  313, 228, 15,  314, 229,
 16,  315, 230, 17,  316, 231, 18,  317,
 232, 19,  318, 233, 20,  319, 234, 21,
 320, 235, 22,  321, 236, 23,  322, 237,
 24,  323, 238, 25,  324, 239, 26,  325,
 240, 27,  326, 241, 28,  327, 242, 29,
 328, 243, 30,  329, 244, 31,  330, 245,
 32,  331, 246, 33,  332, 247, 34,  333,
 248, 35,  334, 249, 36,  335, 250, 37,
 336, 251, 38,  337, 252, 39,  338, 253,
 40,  339, 254, 41,  340, 255, 42,  341,
 128, 43,  342, 129, 44,  343, 130, 45,
 344, 131, 46,  345, 132, 47,  346, 133,
 48,  347, 134, 49,  348, 135, 50,  349,
 136, 51,  350, 137, 52,  351, 138, 53,
 352, 139, 54,  353, 140, 55,  354, 141,
 56,  355, 142, 57,  356, 143, 58,  357,
 144, 59,  358, 145, 60,  359, 146, 61,
 360, 147, 62,  361, 148, 63,  362, 149,
 64,  363, 150, 65,  364, 151, 66,  365,
 152, 67,  366, 153, 68,  367, 154, 69,
 368, 155, 70,  369, 156, 71,  370, 157,
 72,  371, 158, 73,  372, 159, 74,  373,
 160, 75,  374, 161, 76,  375, 162, 77,
 376, 163, 78,  377, 164, 79,  378, 165,
 80,  379, 166, 81,  380, 167, 82,  381,
 168, 83,  382, 169, 84,  383, 170, 85,
 256, 171, 86,  257, 172, 87,  258, 173,
 88,  259, 174, 89,  260, 175, 90,  261,
 176, 91,  262, 177, 92,  263, 178, 93,
 264, 179, 94,  265, 180, 95,  266, 181,
 96,  267, 182, 97,  268, 183, 98,  269,
 184, 99,  270, 185, 100, 271, 186, 101,
 272, 187, 102, 273, 188, 103, 274, 189,
 104, 275, 190, 105, 276, 191, 106, 277,
 192, 107, 278, 193, 108, 279, 194, 109,
 280, 195, 110, 281, 196, 111, 282, 197,
 112, 283, 198, 113, 284, 199, 114, 285,
 200, 115, 286, 201, 116, 287, 202, 117,
 288, 203, 118, 289, 204, 119, 290, 205,
 120, 291, 206, 121, 292, 207, 122, 293,
 208, 123, 294, 209, 124, 295, 210, 125,
 296, 211, 126, 297, 212, 127, 298, 213};

static unsigned short ntab384[384] = {
 0,  256, 128, 129,1,  257, 258, 130,
 2,  3, 259, 131, 132,4, 260,261,
 133,5, 6, 262, 134,135,7,263,
 264,136,8, 9, 265,137,138, 10,
 266, 267,139, 11, 12, 268,140, 141,
 13, 269,270, 142, 14, 15,271, 143,
 144, 16,272, 273, 145, 17,18, 274,
 146, 147,19, 275, 276, 148,20, 21,
 277, 149,150, 22, 278, 279,151, 23,
 24, 280,152, 153, 25, 281,282, 154,
 26, 27,283, 155, 156, 28,284, 285,
 157, 29,30, 286, 158, 159,31, 287,
 288, 160,32, 33, 289, 161,162, 34,
 290, 291,163, 35, 36, 292,164, 165,
 37, 293,294, 166, 38, 39,295, 167,
 168, 40,296, 297, 169, 41,42, 298,
 170, 171,43,  299, 300, 172,44, 45,
 301, 173,174, 46, 302, 303,175, 47,
 48, 304,176, 177, 49, 305,306, 178,
 50, 51,307, 179, 180, 52,308, 309,
 181, 53,54, 310, 182, 183,55, 311,
 312, 184,56, 57, 313,  185,186, 58,
 314, 315,187, 59, 60, 316,188, 189,
 61, 317,318, 190,  62, 63,319, 191,
 192, 64,320, 321, 193, 65,66, 322,
 194, 195,67, 323, 324, 196,68, 69,
 325, 197,198, 70, 326, 327,199, 71,
 72, 328,200, 201, 73, 329,330, 202,
 74, 75,331, 203, 204, 76,332, 333,
 205, 77,78, 334, 206, 207,79, 335,
 336, 208,80, 81, 337, 209,210, 82,
 338, 339,211, 83, 84, 340,212, 213,
 85, 341,342, 214, 86, 87,343, 215,
 216, 88,344, 345, 217, 89,90, 346,
 218, 219,91, 347, 348, 220,92, 93,
 349, 221,222, 94, 350, 351,223, 95,
 96, 352,224, 225, 97, 353,354, 226,
 98, 99,355, 227,  228, 100,356, 357,
 229, 101,102, 358, 230, 231,103, 359,
 360, 232,104, 105, 361, 233,234, 106,
 362, 363,235, 107, 108, 364,236, 237,
 109, 365,366, 238, 110, 111,367, 239,
 240, 112,368, 369, 241, 113,114, 370,
 242, 243,115, 371, 372, 244,116, 117,
 373, 245,246, 118, 374, 375,247, 119,
 120, 376,248, 249, 121, 377,378, 250,
 122, 123,379, 251, 252, 124,380, 381,
 253, 125,126, 382, 254, 255,127, 383};

unsigned char bitrev[64] = {
0x0, 0x20, 0x10, 0x30, 0x8, 0x28, 0x18, 0x38,
0x4, 0x24, 0x14, 0x34, 0xc, 0x2c, 0x1c, 0x3c,
0x2, 0x22, 0x12, 0x32, 0xa, 0x2a, 0x1a, 0x3a,
0x6, 0x26, 0x16, 0x36, 0xe, 0x2e, 0x1e, 0x3e,
0x1, 0x21, 0x11, 0x31, 0x9, 0x29, 0x19, 0x39,
0x5, 0x25, 0x15, 0x35, 0xd, 0x2d, 0x1d, 0x3d,
0x3, 0x23, 0x13, 0x33, 0xb, 0x2b, 0x1b, 0x3b,
0x7, 0x27, 0x17, 0x37, 0xf, 0x2f, 0x1f, 0x3f
};

/* Forward declaration of local functions */



static void gt384_128xfft3(double * x,  double *  y);
static void gt384_reorder(double * in, double * out, unsigned short *tab);
//static inline void gt384_3xfft256(double * xd);

static void gt384_interReorder(double * in, double * out);

static void gt384_fft3(double * x, double * y);

//static inline void gt384_fft3(double *x, double *y);
//static inline void gt384_fft3_ip(double *x);
/* -------------------------------------------------------------------------- */
/*                                                                            */
/*   gt384                                                                     */
/*                                                                            */
/*   Main function for computation of 768-point complex FFT                    */
/*                                                                            */
/* -------------------------------------------------------------------------- */
void gt384(double * x, double * y)
{
    int i,j;

    /* ==== Stage1: k-index reordering ========= */

    gt384_reorder(x, y, ktab384);

    /* ==== Stage 2: make 3 128 point complex FFTs*/
    for(i=0;i<3;i++)
    {
        complete_fft(128,(float *)&y[i*128],(float *)&x[i*128]);
    }

    for(j=0;j<384;j++)
    {
        y[j]= x[j];
    }


    /* ======= Stage 3: intermediate reordering ========== */
    gt384_interReorder(y,x);

    /* ==== Stage3: Do 128 3-point FFTs ========= */
    gt384_128xfft3(x,y);

    /* ==== Stage4: n-index reordering ========= */
    gt384_reorder(y, x, ntab384);

}


void gt384_interReorder(double * in, double * out)
{
    int j,i;

    for (j = 0;j<128;j++)
    {
        for(i = 0;i<3;i++)   //
        {
            out[j*3+i] =  in[i*128 + j];
        }
    }
}
/* -------------------------------------------------------------------------- */
/*                                                                            */
/*  gt384_128xfft3                                                            */
/*                                                                            */
/*  This function makes 128 3pt in-place FFTs on data that is ordered in      */
/*  such a way that the resulting output (i.e. the input to 128pt FFT stage)  */
/*  appears in natural order. That is, FFT k operates on x(k), x(k+128),      */
/*  x(x+256), rather than on x(0+k*3), x(1+k*3), x(2+k*3).                    */
/* -------------------------------------------------------------------------- */

static void gt384_128xfft3(double *  x, double *  y)
{

    int i;

    //    printf("Performing 128 * fft of size 3 \n");

    for(i=0; i<128; i++)
    {
        gt384_fft3(x,y);
             x += (3*1);
             y += (3*1);
    }



}

/* -------------------------------------------------------------------------- */
/*                                                                            */
/*   gt80_reorder                                                             */
/*                                                                            */
/*   Support function for gt384(). Moves data according to an index table.     */
/*   This function should be written in linear assembly to avoid having the   */
/*   index computations being done on the .D unit (via ADDADW etc.)           */
/*                                                                            */
/* -------------------------------------------------------------------------- */
static void gt384_reorder(double * in, double * out, unsigned short *tab)
{
    int i;

    for(i=0; i<384; i++)
    {
        out[tab[i]] = in[i];
    }
}


/* -------------------------------------------------------------------------- */
/*                                                                            */
/*   gt3_subfxn                                                               */
/*                                                                            */
/*   This function computes one 3pt FFT                                       */
/* -------------------------------------------------------------------------- */

//static inline void gt384_fft3(double *x, double *y)
static void gt384_fft3(double *  x,double * y)
{
    float s = 0.866025403784439f;
    float c = -0.5f;

    float * in = (float *) x;
    float * out = (float *) y;


    //    printf("Performing fft of size 3 \n");
    out[0] = in[0] + (in[2] + in[4]); //real(x(1))+real(x(2))+real(x(3))
    out[1] = in[1] + (in[3] + in[5]); //imag(x(1))+imag(x(2))+imag(x(3))
    out[2] = in[0] + (in[2] + in[4])* c + (in[3] - in[5]) * s; //real(x(1)) + (real(x(2))+ real(x(3)))*(cos2pi3) + (imag(x(2))- imag(x(3)))*sin2pi3;
    out[3] = in[1] + (in[3] + in[5])* c + (in[4] - in[2]) * s; //imag(x(1)) + (imag(x(2))+ imag(x(3)))*(cos2pi3) + (real(x(3))- real(x(2)))*sin2pi3;
    out[4] = in[0] + (in[2] + in[4])* c + (in[5] - in[3]) * s; //real(x(1))+(real(x(2))+real(x(3)))*(cos2pi3) + (imag(x(3))- imag(x(2)))*sin2pi3;
    out[5] = in[1] + (in[3] + in[5])* c + (in[2] - in[4]) * s; //imag(x(1))+(imag(x(2))+imag(x(3)))*(cos2pi3) + (real(x(2))- real(x(3)))*sin2pi3;



}


/* -------------------------------------------------------------------------- */
/*                                                                            */
/*   gt3_subfxn_ip                                                            */
/*                                                                            */
/*   This function computes one 3pt FFT                                       */
/* -------------------------------------------------------------------------- */
#if 0
static inline void gt384_fft3_ip(double *x)
{
    float s = 0.866025403784439;
    float c = -.5;
    float t0, t1, t2, t3, t4, t5;

    _nassert(((int) x & 0x7) == 0);

    t0 = x[ 0] + (x[2] + x[4]);
    t1 = x[ 1] + (x[3] + x[5]);
    t2 = x[ 0] + (x[2] + x[4])   * c + (x[3] - x[5]) * s;
    t3 = x[ 1] + (x[3] + x[5]) * c + (x[4] - x[2]) * s;
    t4 = x[ 0] + (x[2] + x[4]) * c + (x[5] - x[3]) * s;
    t5 = x[ 1] + (x[3] + x[5]) * c + (x[2] - x[4]) * s;

    x[ 0] = t0; x[ 1] = t1;
    x[2] = t2; x[3] = t3;
    x[4] = t4; x[5] = t5;
}
#endif

/* ============================================================================= */
/*                               end of gt60.c                                   */
/* ============================================================================= */
